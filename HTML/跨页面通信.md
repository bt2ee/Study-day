https://juejin.cn/post/6844903811232825357#heading-7
### 同源页面

#### BroadCast Channel
创建一个用于广播的通信频道，通过传入相同的 name 来使用同一个广播频道。

```
// 创建
const bc = new BroadcastChannel('XXX');
// 监听
bc.onmessage = function(e) {
    console.log('receive:', e.data);
};
// 错误
bc.onmessageerror = function(e) {
    console.warn('error:', e);
};
// 发送
bc.postMessage('hello')
// 关闭
bc.close();
```

#### Service Worker
Service Worker 是一个可以长期运行在后台的 Worker，能够实现与页面的双向通信。

```
/* 页面注册 */
navigator.serviceWorker.register('../util.sw.js').then(function () {
    console.log('Service Worker 注册成功');
});
```

```
/* ../util.sw.js Service Worker 脚本 */
self.addEventListener('message', function (e) {
    console.log('service worker receive message', e.data);
    e.waitUntil(
        self.clients.matchAll().then(function (clients) {
            if (!clients || clients.length === 0) {
                return;
            }
            clients.forEach(function (client) {
                client.postMessage(e.data);
            });
        })
    );
});
```
在 Service Worker 中监听了message事件，获取页面（从 Service Worker 的角度叫 client）发送的信息。然后通过self.clients.matchAll()获取当前注册了该 Service Worker 的所有页面，通过调用每个client（即页面）的postMessage方法，向页面发送消息。

```
/* 页面监听 */
navigator.serviceWorker.addEventListener('message', function (e) {
    const data = e.data;
    const text = '[receive] ' + data.msg + ' —— tab ' + data.from;
    console.log('[Service Worker] receive message:', text);
});
```

```
/* 消息发送 */
navigator.serviceWorker.controller.postMessage(mydata);
```

#### LocalStorage
当 LocalStorage 变化时，会触发storage事件。利用这个特性，我们可以在发送消息时，把消息写入到某个 LocalStorage 中；然后在各个页面内，通过监听storage事件即可收到通知。

```
window.addEventListener('storage', function (e) {
    if (e.key === 'ctc-msg') {
        const data = JSON.parse(e.newValue);
        const text = '[receive] ' + data.msg + ' —— tab ' + data.from;
        console.log('[Storage I] receive message:', text);
    }
});
```

storage事件只有在值真正改变时才会触发

#### Shared Worker
#### IndexedDB
#### window.open + window.opener

### 非同源页面之间的通信
#### 使用一个用户不可见的 iframe 作为“桥”
